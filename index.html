<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recipe Book</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Small popover video anchored to the clicked button */
    .btn-video-popover {
      position: absolute;
      width: 220px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      z-index: 9999;
      transform-origin: top center;
      animation: pop 150ms ease-out;
    }
    @keyframes pop { from { transform: scale(0.9); opacity: 0 } to { transform: scale(1); opacity: 1 } }
    .btn-video-popover video { display:block; width:100%; height:auto; background:#000 }
    .btn-video-popover .close-small {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(255,255,255,0.12);
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      z-index: 2;
    }
  </style>
</head>

<body class="home">
  <h1>ðŸ“š Recipe Book</h1>

  <input type="text" id="search-input" placeholder="Search recipes by title or tags..." class="search-bar" />

  <div id="recipe-list" class="grid"></div>

  <script>
    let allRecipes = []; // ðŸ”¥ AquÃ­ guardamos todas las recetas ya parseadas

    async function loadRecipes() {
      const container = document.getElementById("recipe-list");
      const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
      let files = [];

      if (isLocal) {
        const dirRes = await fetch("./recipes/");
        const text = await dirRes.text();
        const doc = new DOMParser().parseFromString(text, "text/html");
        const links = [...doc.querySelectorAll("a")];
        files = links
          .map(a => a.getAttribute("href"))
          .filter(h => h && h.endsWith(".md"))
          .map(name => ({ name, url: name }));
      } else {
        const owner = "alainord";
        const repo = "ReceiptApp";
        const folder = "recipes";
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${folder}`;
        const res = await fetch(apiUrl);
        const ghFiles = await res.json();
        files = ghFiles
          .filter(f => f.name.endsWith(".md"))
          .map(f => ({ name: f.name, url: f.download_url }));
      }

      for (const file of files) {
        const mdText = await fetch(file.url).then(r => r.text());

        const title = mdText.match(/^#\s+(.*)/m)?.[1]?.trim() || file.name;
        const desc = mdText
          .replace(/^#.*$/m, "")
          .trim()
          .split("\n")
          .find(l => l.trim().length > 0)
          ?.trim() || "";

        const imageMatch = mdText.match(/!\[[^\]]*\]\((.*?)\)/);
        const image = imageMatch ? imageMatch[1] : "";

        let tags = [];
        const tagSection = mdText.match(/##\s*Tags([\s\S]*?)(##|$)/i);
        if (tagSection) {
          tags = tagSection[1]
            .split("\n")
            .map(l => l.replace(/[-*]\s*/, "").trim())
            .filter(Boolean);
        }

        const recipeUrl = `recipe.html?file=${encodeURIComponent(file.name)}`;

        // Guarda receta en array
        allRecipes.push({
          title,
          desc,
          image,
          tags,
          url: recipeUrl
        });
      }

      renderRecipes(allRecipes);
    }

    function renderRecipes(list) {
      const container = document.getElementById("recipe-list");
      container.innerHTML = "";

      if (!list.length) {
        container.innerHTML = `<p class="empty">No matching recipes found.</p>`;
        return;
      }

      list.forEach(r => {
        container.innerHTML += `
        <article class="recipe-card">
          ${r.image ? `<img src="${r.image}" class="recipe-image" />` : `<div class="recipe-image no-img"></div>`}
          
          ${r.tags.length ? `
            <div class="tag-list">
              ${r.tags
              .map(t => `<span class="recipe-tag" data-tag="${t}">${t}</span>`)
              .join("")}
            </div>
          ` : ""}



          <h2 class="recipe-title">${r.title}</h2>
          <p class="recipe-desc">${r.desc}</p>

          <div class="card-footer">
            <a class="btn" href="${r.url}">View recipe</a>
          </div>
        </article>
      `;
      });
    }

    // ðŸ”Ž SEARCH FUNCTION
    document.getElementById("search-input").addEventListener("input", (e) => {
      const query = e.target.value.toLowerCase();

      const filtered = allRecipes.filter(r =>
        r.title.toLowerCase().includes(query) ||
        r.tags.some(t => t.toLowerCase().includes(query))
      );

      renderRecipes(filtered);
    });
    // ðŸ”¥ Click on tag triggers search
    document.addEventListener("click", e => {
      if (e.target.classList.contains("recipe-tag")) {
        const tag = e.target.dataset.tag.toLowerCase();

        document.getElementById("search-input").value = tag;

        const filtered = allRecipes.filter(r =>
          r.tags.some(t => t.toLowerCase().includes(tag))
        );

        renderRecipes(filtered);
      }
    });

    // When the page loads, check if there is a ?tag=
    window.addEventListener("load", () => {
      const params = new URLSearchParams(window.location.search);
      const tagFromUrl = params.get("tag");

      if (tagFromUrl) {
        const input = document.getElementById("search-input");
        const query = tagFromUrl.toLowerCase();

        // Fill input
        input.value = tagFromUrl;

        // Filter recipes
        const filtered = allRecipes.filter(r =>
          r.tags.some(t => t.toLowerCase().includes(query)) ||
          r.title.toLowerCase().includes(query)
        );

        renderRecipes(filtered);
      }
    });



    loadRecipes();
  </script>

  <script>
    (function () {
      const VIDEO_SRC = './images/6-7.mp4';

      // Create & show a small popover anchored to the button
      function showPopoverAt(button, href) {
        // Remove any existing popover
        const existing = document.querySelector('.btn-video-popover');
        if (existing) existing.remove();

        const pop = document.createElement('div');
        pop.className = 'btn-video-popover';

        const close = document.createElement('button');
        close.className = 'close-small';
        close.textContent = 'âœ•';
        pop.appendChild(close);

        const vid = document.createElement('video');
        vid.setAttribute('playsinline', '');
        vid.setAttribute('webkit-playsinline', '');
        vid.preload = 'auto';
        vid.src = VIDEO_SRC;
        vid.autoplay = true;
        vid.loop = false;
        vid.muted = false;
        vid.controls = false;
        pop.appendChild(vid);

        document.body.appendChild(pop);

        // Position the popover near the button
        const rect = button.getBoundingClientRect();
        const popW = 220;
        const top = window.scrollY + rect.top - 8 - popW * 0.6; // try above
        const left = window.scrollX + rect.left + (rect.width / 2) - (popW / 2);

        pop.style.left = Math.max(8, left) + 'px';
        pop.style.top = Math.max(8, top) + 'px';

        function cleanupAndNavigate() {
          try { vid.pause(); } catch (e) {}
          pop.remove();
          if (href) window.location.href = href;
        }

        // If autoplay blocked, show controls so user can start it
        const p = vid.play();
        if (p && typeof p.then === 'function') {
          p.catch(() => { vid.controls = true; });
        }

        vid.addEventListener('ended', cleanupAndNavigate);
        vid.addEventListener('error', cleanupAndNavigate);

        close.addEventListener('click', () => {
          cleanupAndNavigate();
        });

        // If user clicks outside the popover, close and navigate
        function outsideClick(e) {
          if (!pop.contains(e.target) && e.target !== button) {
            cleanupAndNavigate();
            document.removeEventListener('click', outsideClick);
          }
        }

        setTimeout(() => document.addEventListener('click', outsideClick), 0);
      }

      // Intercept .btn clicks, play small popover video, then navigate
      document.addEventListener('click', function (e) {
        const btn = e.target.closest && e.target.closest('.btn');
        if (!btn) return;

        const href = btn.getAttribute('href');
        if (!href) return;

        e.preventDefault();
        showPopoverAt(btn, href);
      });
    })();
  </script>


</body>

</html>