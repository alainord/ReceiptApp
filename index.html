<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recipe Book</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body class="home">
  <h1>ðŸ“š Recipe Book</h1>
  <p class="subtitle">Your shared Erasmus recipes in one clean place.</p>

  <div id="recipe-list" class="grid"></div>

<script>
async function loadRecipes() {
  const container = document.getElementById("recipe-list");
  container.innerHTML = "";

  const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";

  let files = [];

  if (isLocal) {
    // LOCAL MODE: read files from ./recipes folder (for development)
    try {
      const dirRes = await fetch("./recipes/");
      const text = await dirRes.text();
      const doc = new DOMParser().parseFromString(text, "text/html");
      const links = [...doc.querySelectorAll("a")];
      files = links
        .map(a => a.getAttribute("href"))
        .filter(h => h && h.endsWith(".md"))
        .map(name => ({
          name,
          url: `./recipes/${name}`
        }));
    } catch(e) {
      console.error("Local loading failed:", e);
    }
  }

  if (!isLocal) {
    // ONLINE MODE: load from GitHub
    const owner = "alainord";
    const repo = "ReceiptApp";
    const folder = "recipes";

    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${folder}`;
    const res = await fetch(apiUrl);
    const ghFiles = await res.json();

    files = ghFiles
      .filter(f => f.name.endsWith(".md"))
      .map(f => ({
        name: f.name,
        url: f.download_url
      }));
  }

  if (files.length === 0) {
    container.innerHTML = `<p class="empty">No recipes found.</p>`;
    return;
  }

  // parse each file
  for (const file of files) {
    const mdText = await fetch(file.url).then(r => r.text());

    const title = mdText.match(/^#\s+(.*)/m)?.[1]?.trim() || file.name;

    const desc = mdText
      .replace(/^#.*$/m, "")
      .trim()
      .split("\n")
      .find(l => l.trim().length > 0)
      ?.trim() || "";

    const imageMatch = mdText.match(/!\[[^\]]*\]\((.*?)\)/);
    const image = imageMatch ? imageMatch[1] : "";

    let tag = "";
    const tagSection = mdText.match(/##\s*Tags([\s\S]*?)(##|$)/i);
    if (tagSection) {
      const tagLines = tagSection[1]
        .split("\n")
        .map(l => l.replace(/[-*]\s*/, "").trim())
        .filter(Boolean);
      tag = tagLines[0] || "";
    }

    const recipeUrl = `recipe.html?file=${encodeURIComponent(file.name)}`;

    container.innerHTML += `
      <article class="recipe-card">
        ${image ? `<img src="${image}" alt="${title}" class="recipe-image" />` : `<div class="recipe-image no-img"></div>`}
        ${tag ? `<span class="recipe-tag">${tag}</span>` : ""}
        <h2 class="recipe-title">${title}</h2>
        <p class="recipe-desc">${desc}</p>
        <div class="card-footer">
          <a class="btn" href="${recipeUrl}">View recipe</a>
        </div>
      </article>
    `;
  }
}

loadRecipes();
</script>

</body>

</html>