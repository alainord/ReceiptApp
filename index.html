<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recipe Book</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body class="home">
  <h1>ðŸ“š Recipe Book</h1>
  <p class="subtitle">Your shared Erasmus recipes in one clean place.</p>

  <div id="recipe-list" class="grid"></div>

  <script>
    async function loadRecipes() {
      const owner = "alainord";
      const repo = "ReceiptApp";
      const folder = "recipes";

      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${folder}`;

      try {
        const res = await fetch(apiUrl);
        const files = await res.json();

        const container = document.getElementById("recipe-list");
        container.innerHTML = "";

        if (!Array.isArray(files) || files.length === 0) {
          container.innerHTML = `<p class="empty">No recipes yet.</p>`;
          return;
        }

        for (const file of files.filter(f => f.name.endsWith(".md"))) {
          const rawMdUrl = file.download_url;
          const mdText = await fetch(rawMdUrl).then(r => r.text());

          // Extract TITLE = first "# "
          const titleMatch = mdText.match(/^[ \t]*#\s+(.*)$/m);
          console.log("MD Text:", mdText);
          const title = titleMatch ? titleMatch[1].trim() : file.name;
          console.log("Title:", title);
          // Extract DESCRIPTION = first paragraph after title
          const desc = (() => {
            const withoutTitle = mdText.replace(/^[ \t]*#.*$/m, "").trim(); // remove title line allowing leading spaces
            const firstParagraphLine = withoutTitle.split("\n").find(line => line.trim().length > 0);
            return firstParagraphLine ? firstParagraphLine.trim() : "";
          })().trim() || "";

          // Extract FIRST IMAGE: ![alt](url)
          const imageMatch = mdText.match(/!\[[^\]]*\]\((.*?)\)/);
          const image = imageMatch ? imageMatch[1] : "";

          // Extract TAGS block:
          // ## Tags ... then bullet list
          let tag = "";
          const tagSection = mdText.match(/##\s*Tags([\s\S]*?)(##|$)/i);
          if (tagSection) {
            const tagLines = tagSection[1]
              .split("\n")
              .map(l => l.replace(/[-*]\s*/, "").trim())
              .filter(Boolean);
            tag = tagLines[0] || ""; // use first tag
          }

          const recipeUrl = `recipe.html?file=${encodeURIComponent(file.name)}`;

          container.innerHTML += `
          <article class="recipe-card">
            ${image ? `<img src="${image}" alt="${title}" class="recipe-image" />` : `<div class="recipe-image no-img"></div>`}
            ${tag ? `<span class="recipe-tag">${tag}</span>` : ""}
            <h2 class="recipe-title">${title}</h2>
            <p class="recipe-desc">${desc}</p>
            <div class="card-footer">
              <a class="btn" href="${recipeUrl}">View recipe</a>
            </div>
          </article>
        `;
        }

      } catch (err) {
        console.error("Error loading recipes:", err);
        document.getElementById("recipe-list").innerHTML =
          `<p class="empty">Could not load recipes. Try again later.</p>`;
      }
    }

    loadRecipes();
  </script>

</body>

</html>