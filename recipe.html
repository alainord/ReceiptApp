<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recipe</title>

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <link rel="stylesheet" href="styles.css">
</head>

<body class="recipe">
  <a href="index.html" class="back">← Back to recipes</a>

  <article class="card" id="recipe-card">
    <p>Loading recipe…</p>
  </article>

  <script>
    async function loadRecipe() {
      const isLocal =
        location.hostname === "localhost" ||
        location.hostname === "127.0.0.1";

      const params = new URLSearchParams(window.location.search);
      const file = params.get("file");

      if (!file) {
        document.getElementById("recipe-card").innerHTML =
          "<p>No recipe selected.</p>";
        return;
      }

      // Clean filename
      const cleanFile = file.replace(/^recipes\//, "").trim();

      // Choose correct source
      const owner = "alainord";
      const repo = "ReceiptApp";

      let rawUrl = isLocal
        ? `${window.location.origin}/${cleanFile}`
        : `https://raw.githubusercontent.com/${owner}/${repo}/main/recipes/${cleanFile}`;

      try {
        const mdText = await fetch(rawUrl).then(r => r.text());

        /* ─────────────────────────────────────────────────────────────
           EXTRACT THE PARTS FROM MARKDOWN
        ─────────────────────────────────────────────────────────────── */

        // Title
        const title = mdText.match(/^#\s+(.*)/m)?.[1]?.trim() || cleanFile;

        // Description (first paragraph after title)
        const desc = mdText
          .replace(/^#.*$/m, "")
          .trim()
          .split("\n")
          .find(l => l.trim().length > 0) || "";

        // Hero image (first image)
        const imageMatch = mdText.match(/!\[[^\]]*\]\((.*?)\)/);
        const heroImage = imageMatch ? imageMatch[1] : "";

        // Ingredients
        // Ingredients with categories
        let ingredients = [];
        const ingSection = mdText.match(/##\s*Ingredients([\s\S]*?)(##|$)/i);
        if (ingSection) {
          const lines = ingSection[1].split("\n").map(l => l.trim()).filter(Boolean);

          let currentCategory = "General";
          ingredients = [];

          for (const line of lines) {
            // If the line is a bold category title like **Protein & Base**
            const catMatch = line.match(/^\*\*(.+?)\*\*$/);
            if (catMatch) {
              currentCategory = catMatch[1].trim();
              continue;
            }

            // If it's a bullet like "- Chicken"
            const itemMatch = line.match(/^-+\s*(.+)$/);
            if (itemMatch) {
              ingredients.push({
                category: currentCategory,
                item: itemMatch[1].trim()
              });
            }
          }
        }


        // Steps
        let steps = [];
        const stepsSection = mdText.match(/##\s*Steps([\s\S]*?)(##|$)/i);
        if (stepsSection) {
          steps = stepsSection[1]
            .split("\n")
            .map(l => l.replace(/^\d+\.\s*/, "").trim())
            .filter(Boolean);
        }

        // Tags
        let tags = [];
        const tagSection = mdText.match(/##\s*Tags([\s\S]*?)(##|$)/i);
        if (tagSection) {
          tags = tagSection[1]
            .split("\n")
            .map(l => l.replace(/[-*]\s*/, "").trim())
            .filter(Boolean);
        }

        /* ─────────────────────────────────────────────────────────────
           CLEAN MARKDOWN FOR FINAL RENDER
        ─────────────────────────────────────────────────────────────── */

        let cleanedMd = mdText;

        // Remove title line
        cleanedMd = cleanedMd.replace(/^#\s+.*$/m, "");

        // Remove first description paragraph
        // Remove the description paragraph from the markdown
        if (desc) {
          const escDesc = desc.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // escape regex chars
          const descRegex = new RegExp("^\\s*" + escDesc + "\\s*$", "m");
          cleanedMd = cleanedMd.replace(descRegex, "");
        }

        // Remove first image
        cleanedMd = cleanedMd.replace(/!\[[^\]]*\]\((.*?)\)/, "");

        // Remove entire Ingredients section
        cleanedMd = cleanedMd.replace(/##\s*Ingredients[\s\S]*?(?=##|$)/i, "");

        // Remove entire Steps section
        cleanedMd = cleanedMd.replace(/##\s*Steps[\s\S]*?(?=##|$)/i, "");

        // Remove entire Tags section
        cleanedMd = cleanedMd.replace(/##\s*Tags[\s\S]*?(?=##|$)/i, "");

        cleanedMd = cleanedMd.trim();

        const bodyHtml = marked.parse(cleanedMd);

        /* ─────────────────────────────────────────────────────────────
           RENDER HTML
        ─────────────────────────────────────────────────────────────── */

        const card = document.getElementById("recipe-card");

        card.innerHTML = `
          ${heroImage ? `<img src="${heroImage}" alt="${title}" class="hero-image" />` : ""}

          <h1>${title}</h1>
          <p class="subtitle">${desc}</p>

          ${tags.length ? `
            <div class="tag-list">
              ${tags.map(t => `<span class="recipe-tag">${t}</span>`).join("")}
            </div>
          ` : ""}

         ${ingredients.length ? `
          <h2 class="section-title">Ingredients</h2>

          ${(() => {
            // Group by category
            const groups = {};
            for (const ing of ingredients) {
              if (!groups[ing.category]) groups[ing.category] = [];
              groups[ing.category].push(ing.item);
            }

            return Object.entries(groups).map(([cat, items]) => `
              <h3 class="ingredient-category">${cat}</h3>
              <ul>
                ${items.map(i => `<li>${i}</li>`).join("")}
              </ul>
            `).join("");
          })()}
        ` : ""}


          ${steps.length ? `
            <h2 class="section-title">Steps</h2>
            <ol>
              ${steps.map(s => `<li>${s}</li>`).join("")}
            </ol>
          ` : ""}

          <div class="content">
            ${bodyHtml}
          </div>
        `;
      } catch (err) {
        console.error(err);
        document.getElementById("recipe-card").innerHTML =
          "<p>Could not load this recipe. Maybe it was deleted.</p>";
      }
    }

    loadRecipe();
  </script>

</body>

</html>